//
//  DIContainer+AutoDI.swift
//  DiContainer
//
//  Created by Wonji Suh on 2024.
//

import Foundation

// MARK: - Auto DI Features

/// ìë™ ì˜ì¡´ì„± ì£¼ì… ê¸°ëŠ¥ í™•ì¥
public extension DIContainer {

  /// ğŸš€ ìë™ ìƒì„±ëœ ì˜ì¡´ì„± ê·¸ë˜í”„ë¥¼ ì‹œê°í™”í•©ë‹ˆë‹¤
  ///
  /// ë³„ë„ ì„¤ì • ì—†ì´ ìë™ìœ¼ë¡œ ìˆ˜ì§‘ëœ ì˜ì¡´ì„± ê´€ê³„ë¥¼ í…ìŠ¤íŠ¸ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
  func getAutoGeneratedGraph() -> String {
    AutoDIOptimizer.readSnapshot().graphText
  }

  /// âš¡ ìë™ ìµœì í™”ëœ íƒ€ì…ë“¤ì„ ë°˜í™˜í•©ë‹ˆë‹¤
  ///
  /// ì‚¬ìš© íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ìë™ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”ê°€ ì ìš©ëœ íƒ€ì…ë“¤ì˜ ëª©ë¡ì…ë‹ˆë‹¤.
  func getOptimizedTypes() -> Set<String> {
    let freq = AutoDIOptimizer.readSnapshot().frequentlyUsed
    return Set(freq.filter { $0.value >= 3 }.keys)
  }

  /// âš ï¸ ìë™ ê°ì§€ëœ ìˆœí™˜ ì˜ì¡´ì„±ì„ ë°˜í™˜í•©ë‹ˆë‹¤
  ///
  /// ì˜ì¡´ì„± ë“±ë¡/í•´ê²° ê³¼ì •ì—ì„œ ìë™ìœ¼ë¡œ ê°ì§€ëœ ìˆœí™˜ ì˜ì¡´ì„± ëª©ë¡ì…ë‹ˆë‹¤.
  func getDetectedCircularDependencies() -> Set<String> {
    let snap = AutoDIOptimizer.readSnapshot()
    var visited: Set<String> = []
    var stack: Set<String> = []
    var cycles: Set<String> = []
    func dfs(_ node: String) {
      if stack.contains(node) { cycles.insert("ìˆœí™˜ ê°ì§€: \(node)"); return }
      if visited.contains(node) { return }
      visited.insert(node); stack.insert(node)
      for dep in snap.dependencies where dep.from == node { dfs(dep.to) }
      stack.remove(node)
    }
    for t in snap.registered where !visited.contains(t) { dfs(t) }
    return cycles
  }

  /// ğŸ“Š ìë™ ìˆ˜ì§‘ëœ ì„±ëŠ¥ í†µê³„ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤
  ///
  /// ê° íƒ€ì…ì˜ ì‚¬ìš© ë¹ˆë„ê°€ ìë™ìœ¼ë¡œ ì¶”ì ë©ë‹ˆë‹¤.
  func getUsageStatistics() -> [String: Int] {
    AutoDIOptimizer.readSnapshot().frequentlyUsed
  }

  /// ğŸ” íŠ¹ì • íƒ€ì…ì´ ìë™ ìµœì í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤
  ///
  /// - Parameter type: í™•ì¸í•  íƒ€ì…
  /// - Returns: ìµœì í™” ì—¬ë¶€
  func isAutoOptimized<T>(_ type: T.Type) -> Bool {
    let name = String(describing: type)
    let freq = AutoDIOptimizer.readSnapshot().frequentlyUsed
    return (freq[name] ?? 0) >= 5
  }

  /// âš™ï¸ ìë™ ìµœì í™” ê¸°ëŠ¥ì„ ì œì–´í•©ë‹ˆë‹¤
  ///
  /// - Parameter enabled: í™œì„±í™” ì—¬ë¶€ (ê¸°ë³¸ê°’: true)
  func setAutoOptimization(_ enabled: Bool) {
    Task { @DIActor in AutoDIOptimizer.shared.setOptimizationEnabled(enabled) }
  }

  /// ğŸ§¹ ìë™ ìˆ˜ì§‘ëœ í†µê³„ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤
  func resetAutoStats() {
    Task { @DIActor in AutoDIOptimizer.shared.resetStats() }
  }
}
