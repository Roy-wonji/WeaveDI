//
//  ContainerCore.swift
//  DiContainer
//
//  Created by Wonja Suh on 3/19/25.
//

import Foundation

// MARK: - Container Core Implementation

/// ## ê°œìš”
///
/// `Container`ëŠ” ì—¬ëŸ¬ ê°œì˜ `Module` ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìˆ˜ì§‘í•˜ê³  ì¼ê´„ ë“±ë¡í•  ìˆ˜ ìžˆëŠ”
/// Swift Concurrency ê¸°ë°˜ì˜ ì•¡í„°ìž…ë‹ˆë‹¤. ì´ ì»¨í…Œì´ë„ˆëŠ” ëŒ€ê·œëª¨ ì˜ì¡´ì„± ê·¸ëž˜í”„ë¥¼
/// íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê³  ë³‘ë ¬ ì²˜ë¦¬ë¥¼ í†µí•´ ì„±ëŠ¥ì„ ìµœì í™”í•©ë‹ˆë‹¤.
///
/// ## í•µì‹¬ íŠ¹ì§•
///
/// ### âš¡ ê³ ì„±ëŠ¥ ë³‘ë ¬ ì²˜ë¦¬
/// - **Task Group í™œìš©**: ëª¨ë“  ëª¨ë“ˆì˜ ë“±ë¡ì„ ë™ì‹œì— ë³‘ë ¬ ì‹¤í–‰
/// - **ìŠ¤ëƒ…ìƒ· ê¸°ë°˜**: ë‚´ë¶€ ë°°ì—´ì„ ë³µì‚¬í•˜ì—¬ actor hop ìµœì†Œí™”
/// - **ë¹„ë™ê¸° ì•ˆì „**: Swift Concurrency íŒ¨í„´ìœ¼ë¡œ ìŠ¤ë ˆë“œ ì•ˆì „ì„± ë³´ìž¥
///
/// ### ðŸ—ï¸ ë°°ì¹˜ ë“±ë¡ ì‹œìŠ¤í…œ
/// - **ëª¨ë“ˆ ìˆ˜ì§‘**: ì—¬ëŸ¬ ëª¨ë“ˆì„ ë¨¼ì € ìˆ˜ì§‘í•œ í›„ í•œ ë²ˆì— ë“±ë¡
/// - **ì§€ì—° ì‹¤í–‰**: `build()` í˜¸ì¶œ ì‹œì ê¹Œì§€ ì‹¤ì œ ë“±ë¡ ì§€ì—°
/// - **ì›ìžì  ì²˜ë¦¬**: ëª¨ë“  ëª¨ë“ˆì´ í•¨ê»˜ ë“±ë¡ë˜ê±°ë‚˜ ì‹¤íŒ¨
///
/// ### ðŸ”’ ë™ì‹œì„± ì•ˆì „ì„±
/// - **Actor ë³´í˜¸**: ë‚´ë¶€ ìƒíƒœ(`modules`)ê°€ ë°ì´í„° ê²½ìŸìœ¼ë¡œë¶€í„° ì•ˆì „
/// - **ìˆœì„œ ë…ë¦½**: ëª¨ë“ˆ ë“±ë¡ ìˆœì„œì™€ ë¬´ê´€í•˜ê²Œ ë™ìž‘
/// - **ë©”ëª¨ë¦¬ ì•ˆì „**: ì•½í•œ ì°¸ì¡° ì—†ì´ë„ ì•ˆì „í•œ ë©”ëª¨ë¦¬ ê´€ë¦¬
public actor Container {
    // MARK: - ì €ìž¥ í”„ë¡œí¼í‹°

    /// ë“±ë¡ëœ ëª¨ë“ˆ(Module) ì¸ìŠ¤í„´ìŠ¤ë“¤ì„ ì €ìž¥í•˜ëŠ” ë‚´ë¶€ ë°°ì—´.
    internal var modules: [Module] = []

    // MARK: - ì´ˆê¸°í™”

    /// ê¸°ë³¸ ì´ˆê¸°í™” ë©”ì„œë“œ.
    /// - ì„¤ëª…: ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œ `modules` ë°°ì—´ì€ ë¹ˆ ìƒíƒœë¡œ ì‹œìž‘ë©ë‹ˆë‹¤.
    public init() {}

    // MARK: - ëª¨ë“ˆ ë“±ë¡

    /// ëª¨ë“ˆì„ ì»¨í…Œì´ë„ˆì— ì¶”ê°€í•˜ì—¬ ë‚˜ì¤‘ì— ì¼ê´„ ë“±ë¡í•  ìˆ˜ ìžˆë„ë¡ ì¤€ë¹„í•©ë‹ˆë‹¤.
    ///
    /// ì´ ë©”ì„œë“œëŠ” ì¦‰ì‹œ ëª¨ë“ˆì„ DI ì»¨í…Œì´ë„ˆì— ë“±ë¡í•˜ì§€ ì•Šê³ , ë‚´ë¶€ ë°°ì—´ì— ì €ìž¥ë§Œ í•©ë‹ˆë‹¤.
    /// ì‹¤ì œ ë“±ë¡ì€ `build()` ë©”ì„œë“œ í˜¸ì¶œ ì‹œì— ëª¨ë“  ëª¨ë“ˆì´ ë³‘ë ¬ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
    ///
    /// - Parameter module: ë“±ë¡ ì˜ˆì•½í•  `Module` ì¸ìŠ¤í„´ìŠ¤
    /// - Returns: ì²´ì´ë‹ì„ ìœ„í•œ í˜„ìž¬ `Container` ì¸ìŠ¤í„´ìŠ¤
    ///
    /// - Note: ì´ ë©”ì„œë“œëŠ” ì‹¤ì œ ë“±ë¡ì„ ìˆ˜í–‰í•˜ì§€ ì•Šê³  ëª¨ë“ˆì„ íì— ì¶”ê°€ë§Œ í•©ë‹ˆë‹¤.
    /// - Important: ë™ì¼í•œ íƒ€ìž…ì˜ ëª¨ë“ˆì„ ì—¬ëŸ¬ ë²ˆ ë“±ë¡í•˜ë©´ ë§ˆì§€ë§‰ ë“±ë¡ì´ ìš°ì„ ë©ë‹ˆë‹¤.
    /// - SeeAlso: `build()` - ì‹¤ì œ ëª¨ë“  ëª¨ë“ˆì„ ë³‘ë ¬ ë“±ë¡í•˜ëŠ” ë©”ì„œë“œ
    @discardableResult
    public func register(_ module: Module) -> Self {
        modules.append(module)
        return self
    }

    /// Trailing closureë¥¼ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©ë˜ëŠ” ë©”ì„œë“œìž…ë‹ˆë‹¤.
    ///
    /// - Parameter block: í˜¸ì¶œ ì¦‰ì‹œ ì‹¤í–‰í•  í´ë¡œì €. ì´ í´ë¡œì € ë‚´ë¶€ì—ì„œ ì¶”ê°€ ì„¤ì •ì„ ìˆ˜í–‰í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
    /// - Returns: í˜„ìž¬ `Container` ì¸ìŠ¤í„´ìŠ¤(Self). ë©”ì„œë“œ ì²´ì´ë‹(Fluent API) ë°©ì‹ìœ¼ë¡œ ì—°ì‡„ í˜¸ì¶œì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    @discardableResult
    public func callAsFunction(_ block: () -> Void) -> Self {
        block()
        return self
    }

    // MARK: - ìƒíƒœ ì¡°íšŒ

    /// í˜„ìž¬ ë“±ë¡ ëŒ€ê¸° ì¤‘ì¸ ëª¨ë“ˆì˜ ê°œìˆ˜ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    /// - Returns: ëŒ€ê¸° ì¤‘ì¸ ëª¨ë“ˆ ê°œìˆ˜
    public var moduleCount: Int {
        modules.count
    }

    /// ì»¨í…Œì´ë„ˆê°€ ë¹„ì–´ìžˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    /// - Returns: ë“±ë¡ëœ ëª¨ë“ˆì´ ì—†ìœ¼ë©´ true
    public var isEmpty: Bool {
        modules.isEmpty
    }

    /// ë“±ë¡ëœ ëª¨ë“ˆë“¤ì˜ íƒ€ìž… ì´ë¦„ì„ ë°˜í™˜í•©ë‹ˆë‹¤ (ë””ë²„ê¹…ìš©).
    /// - Returns: ëª¨ë“ˆ íƒ€ìž… ì´ë¦„ ë°°ì—´
    public func getModuleTypeNames() -> [String] {
        modules.map { String(describing: type(of: $0)) }
    }
}