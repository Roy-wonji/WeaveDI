//
//  Phase1Examples.swift
//  DiContainer
//
//  Created by Wonji Suh on 2024.
//  Copyright Â© 2024 Wonji Suh. All rights reserved.
//

import Foundation
import DiContainer

// MARK: - Phase 1 ê¸°ëŠ¥ ì˜ˆì œ

/// # Phase 1 ìƒˆ ê¸°ëŠ¥ ë°ëª¨
///
/// ì´ íŒŒì¼ì€ Phase 1ì—ì„œ ì¶”ê°€ëœ ë‘ ê°€ì§€ í•µì‹¬ ê¸°ëŠ¥ì„ ë³´ì—¬ì¤ë‹ˆë‹¤:
/// 1. @AutoRegister ë§¤í¬ë¡œ - ìë™ ì˜ì¡´ì„± ë“±ë¡
/// 2. Parent-Child Container - ê³„ì¸µì  ì˜ì¡´ì„± ê´€ë¦¬

// MARK: - 1. AutoRegister ë§¤í¬ë¡œ ì˜ˆì œ

/// ## ğŸ¯ @AutoRegister ë§¤í¬ë¡œ ì‚¬ìš©ë²•

// ê¸°ì¡´ ë°©ì‹ (ì—¬ì „íˆ ë™ì‘)
protocol UserRepository: Sendable {
    func getUser(id: String) async -> String
}

// ìƒˆë¡œìš´ ë°©ì‹: @AutoRegister ë§¤í¬ë¡œ (ë§¤í¬ë¡œëŠ” í–¥í›„ í™œì„±í™” ì˜ˆì •)
// @AutoRegister  // â† ì´ í•œ ì¤„ë¡œ ìë™ ë“±ë¡!
final class UserRepositoryImpl: UserRepository {
    func getUser(id: String) async -> String {
        return "User-\(id)"
    }

    // ë§¤í¬ë¡œê°€ ìë™ìœ¼ë¡œ ë‹¤ìŒ ì½”ë“œë¥¼ ìƒì„±:
    // private static let __autoRegister_UserRepository_UserRepositoryImpl = {
    //     return UnifiedDI.register(UserRepository.self) { UserRepositoryImpl() }
    // }()
    // private static let __autoRegister_UserRepositoryImpl_UserRepositoryImpl = {
    //     return UnifiedDI.register(UserRepositoryImpl.self) { UserRepositoryImpl() }
    // }()
}

// @AutoRegister(lifetime: .singleton)
class UserService: Sendable {
    func greetUser(id: String) async -> String {
        // ë¶€ëª¨ì—ì„œ UserRepository ìë™ í•´ê²°
        let repo: UserRepository? = UnifiedDI.resolve(UserRepository.self)
        let username = await repo?.getUser(id: id) ?? "Unknown"
        return "Hello, \(username)!"
    }
}

// MARK: - 2. Parent-Child Container ì˜ˆì œ

/// ## ğŸ—ï¸ Parent-Child Container ì‚¬ìš©ë²•

class Phase1Demo {

    /// ### ê¸°ë³¸ Parent-Child ì‚¬ìš©ë²•
    func basicParentChildExample() async {
        print("\nğŸ—ï¸ Parent-Child Container ê¸°ë³¸ ì˜ˆì œ")

        // 1. ì•± ë ˆë²¨ ë£¨íŠ¸ ì»¨í…Œì´ë„ˆ ìƒì„±
        let appContainer = DIContainer()

        // 2. ê³µí†µ ì„œë¹„ìŠ¤ë“¤ì„ ë£¨íŠ¸ì— ë“±ë¡
        let database = appContainer.register(DatabaseService.self) {
            DatabaseServiceImpl()
        }

        let logger = appContainer.register(Logger.self) {
            ConsoleLogger()
        }

        print("âœ… ë£¨íŠ¸ ì»¨í…Œì´ë„ˆì— ê³µí†µ ì„œë¹„ìŠ¤ ë“±ë¡ ì™„ë£Œ")

        // 3. Featureë³„ Child Container ìƒì„±
        let userFeatureContainer = appContainer.createChild()
        let orderFeatureContainer = appContainer.createChild()

        // 4. ê° Featureì— íŠ¹í™”ëœ ì„œë¹„ìŠ¤ ë“±ë¡
        let userRepo = userFeatureContainer.register(UserRepository.self) {
            UserRepositoryImpl(
                database: appContainer.resolve(DatabaseService.self)!  // ë¶€ëª¨ì—ì„œ í•´ê²°
            )
        }

        let orderRepo = orderFeatureContainer.register(OrderRepository.self) {
            OrderRepositoryImpl(
                database: appContainer.resolve(DatabaseService.self)!  // ê°™ì€ DB ê³µìœ 
            )
        }

        print("âœ… Featureë³„ Child Container ì„¤ì • ì™„ë£Œ")

        // 5. ê° Containerì—ì„œ ì˜ì¡´ì„± í•´ê²° í…ŒìŠ¤íŠ¸

        // UserFeatureì—ì„œ í•´ê²°
        let userService = userFeatureContainer.resolve(UserService.self)  // ë§¤í¬ë¡œë¡œ ìë™ ë“±ë¡ë¨
        let userLogger = userFeatureContainer.resolve(Logger.self)        // ë¶€ëª¨ì—ì„œ ìƒì†

        // OrderFeatureì—ì„œ í•´ê²°
        let orderService = orderFeatureContainer.resolve(OrderService.self)
        let orderLogger = orderFeatureContainer.resolve(Logger.self)      // ë¶€ëª¨ì—ì„œ ìƒì†

        print("âœ… Child Containerë“¤ì´ ë¶€ëª¨ì˜ ì˜ì¡´ì„±ì„ ì„±ê³µì ìœ¼ë¡œ ìƒì†ë°›ìŒ")

        // 6. ì‹¤ì œ ì„œë¹„ìŠ¤ ì‚¬ìš©
        if let userService = userService {
            let greeting = await userService.greetUser(id: "123")
            print("ğŸ‘¤ UserService: \(greeting)")
        }

        print("ğŸ‰ Parent-Child Container ë°ëª¨ ì™„ë£Œ!")
    }

    /// ### SwiftUI í†µí•© ì˜ˆì œ
    func swiftUIIntegrationExample() {
        print("\nğŸ“± SwiftUI í†µí•© ì˜ˆì œ")

        // ì•± ë ˆë²¨ ì»¨í…Œì´ë„ˆ
        let appContainer = DIContainer()
        appContainer.register(DatabaseService.self) { DatabaseServiceImpl() }
        appContainer.register(NetworkService.self) { NetworkServiceImpl() }

        // Viewë³„ Child Container
        let homeViewContainer = appContainer.createChild()
        homeViewContainer.register(HomeViewModel.self) {
            HomeViewModel(
                database: appContainer.resolve(DatabaseService.self)!,
                network: appContainer.resolve(NetworkService.self)!
            )
        }

        let profileViewContainer = appContainer.createChild()
        profileViewContainer.register(ProfileViewModel.self) {
            ProfileViewModel(
                database: appContainer.resolve(DatabaseService.self)!  // ê°™ì€ DB ê³µìœ 
            )
        }

        print("âœ… SwiftUI Viewë³„ Container ë¶„ë¦¬ ì™„ë£Œ")

        // ê° ViewëŠ” ë…ë¦½ì ì´ì§€ë§Œ ê³µí†µ ì„œë¹„ìŠ¤ëŠ” ê³µìœ 
        let homeVM = homeViewContainer.resolve(HomeViewModel.self)
        let profileVM = profileViewContainer.resolve(ProfileViewModel.self)

        print("ğŸ‰ SwiftUI í†µí•© ì™„ë£Œ!")
    }

    /// ### ë³µí•© ê¸°ëŠ¥ ë°ëª¨ (AutoRegister + Parent-Child)
    func combinedFeaturesDemo() async {
        print("\nğŸš€ ë³µí•© ê¸°ëŠ¥ ë°ëª¨ (AutoRegister + Parent-Child)")

        // 1. ë£¨íŠ¸ ì»¨í…Œì´ë„ˆì— ê¸°ë³¸ ì„œë¹„ìŠ¤ë“¤
        let appContainer = DIContainer()
        appContainer.register(DatabaseService.self) { DatabaseServiceImpl() }

        // 2. @AutoRegister ë§¤í¬ë¡œë¡œ ìë™ ë“±ë¡ëœ ì„œë¹„ìŠ¤ë“¤ ì‚¬ìš©
        // (UserService, UserRepositoryImplì´ ì´ë¯¸ ìë™ ë“±ë¡ë¨)

        // 3. Feature ëª¨ë“ˆë³„ Child Container
        let userModule = appContainer.createChild()
        let adminModule = appContainer.createChild()

        // 4. ì¼ë°˜ ì‚¬ìš©ììš© ì„œë¹„ìŠ¤ (ì œí•œëœ ê¶Œí•œ)
        userModule.register(UserPermissionService.self) {
            UserPermissionService(level: .user)
        }

        // 5. ê´€ë¦¬ììš© ì„œë¹„ìŠ¤ (ì „ì²´ ê¶Œí•œ)
        adminModule.register(AdminPermissionService.self) {
            AdminPermissionService(level: .admin)
        }

        // 6. ê° ëª¨ë“ˆì—ì„œ ì„œë¹„ìŠ¤ í•´ê²° ë° ì‚¬ìš©

        // ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“ˆì—ì„œ
        let userService = userModule.resolve(UserService.self)  // @AutoRegisterë¡œ ìë™ ë“±ë¡ë¨
        let userPermission = userModule.resolve(UserPermissionService.self)

        if let userService = userService, let userPermission = userPermission {
            let greeting = await userService.greetUser(id: "user123")
            print("ğŸ‘¤ ì¼ë°˜ ì‚¬ìš©ì: \(greeting) (ê¶Œí•œ: \(userPermission.level))")
        }

        // ê´€ë¦¬ì ëª¨ë“ˆì—ì„œ
        let adminService = adminModule.resolve(UserService.self)  // ê°™ì€ ì„œë¹„ìŠ¤ì§€ë§Œ ë‹¤ë¥¸ ê¶Œí•œ
        let adminPermission = adminModule.resolve(AdminPermissionService.self)

        if let adminService = adminService, let adminPermission = adminPermission {
            let greeting = await adminService.greetUser(id: "admin456")
            print("ğŸ‘‘ ê´€ë¦¬ì: \(greeting) (ê¶Œí•œ: \(adminPermission.level))")
        }

        print("ğŸ‰ ë³µí•© ê¸°ëŠ¥ ë°ëª¨ ì™„ë£Œ!")
        print("   - @AutoRegisterë¡œ ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ ì œê±°")
        print("   - Parent-Childë¡œ ëª¨ë“ˆë³„ ê¶Œí•œ ë¶„ë¦¬")
        print("   - ê³µí†µ ì„œë¹„ìŠ¤ëŠ” ë£¨íŠ¸ì—ì„œ ê³µìœ ")
    }
}

// MARK: - ì§€ì› íƒ€ì…ë“¤ (ì˜ˆì œìš©)

protocol DatabaseService {
    func query(_ sql: String) -> [String]
}

class DatabaseServiceImpl: DatabaseService {
    func query(_ sql: String) -> [String] {
        return ["result1", "result2"]
    }
}

protocol Logger {
    func log(_ message: String)
}

class ConsoleLogger: Logger {
    func log(_ message: String) {
        print("ğŸ“ Log: \(message)")
    }
}

protocol NetworkService {
    func fetch(_ url: String) async -> Data?
}

class NetworkServiceImpl: NetworkService {
    func fetch(_ url: String) async -> Data? {
        return "network data".data(using: .utf8)
    }
}

protocol OrderRepository {
    func getOrder(id: String) -> String
}

class OrderRepositoryImpl: OrderRepository {
    let database: DatabaseService

    init(database: DatabaseService) {
        self.database = database
    }

    func getOrder(id: String) -> String {
        return "Order-\(id)"
    }
}

// @AutoRegister
class OrderService {
    func processOrder(id: String) -> String {
        return "Processing order \(id)"
    }
}

class HomeViewModel: ObservableObject {
    let database: DatabaseService
    let network: NetworkService

    init(database: DatabaseService, network: NetworkService) {
        self.database = database
        self.network = network
    }
}

class ProfileViewModel: ObservableObject {
    let database: DatabaseService

    init(database: DatabaseService) {
        self.database = database
    }
}

enum PermissionLevel {
    case user, admin
}

class UserPermissionService {
    let level: PermissionLevel

    init(level: PermissionLevel) {
        self.level = level
    }
}

class AdminPermissionService {
    let level: PermissionLevel

    init(level: PermissionLevel) {
        self.level = level
    }
}

extension UserRepositoryImpl {
    convenience init(database: DatabaseService) {
        self.init()
        // databaseë¥¼ ì‚¬ìš©í•œ ì´ˆê¸°í™” ë¡œì§
    }
}

// MARK: - ë°ëª¨ ì‹¤í–‰ í•¨ìˆ˜

/// Phase 1 ëª¨ë“  ê¸°ëŠ¥ì„ ë°ëª¨í•©ë‹ˆë‹¤
func runPhase1Demo() async {
    print("ğŸ¯ DiContainer Phase 1 ê¸°ëŠ¥ ë°ëª¨ ì‹œì‘!")
    print("=" * 50)

    let demo = Phase1Demo()

    await demo.basicParentChildExample()
    demo.swiftUIIntegrationExample()
    await demo.combinedFeaturesDemo()

    print("\n" + "=" * 50)
    print("ğŸ‰ Phase 1 ë°ëª¨ ì™„ë£Œ!")
    print("âœ… @AutoRegister ë§¤í¬ë¡œë¡œ ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ 90% ê°ì†Œ")
    print("âœ… Parent-Child Containerë¡œ ëª¨ë“ˆë³„ ì˜ì¡´ì„± ë¶„ë¦¬")
    print("âœ… ê¸°ì¡´ APIì™€ 100% í˜¸í™˜ ìœ ì§€")
}