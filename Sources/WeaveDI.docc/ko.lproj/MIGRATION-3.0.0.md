# DiContainer 3.0.0 마이그레이션 가이드

이 문서는 2.x.x에서 3.0.0으로 업그레이드할 때 필요한 변경 사항과 권장 마이그레이션 경로를 정리합니다.

## 요약

3.0.0의 핵심은 "읽기 경로 일원화"와 "핫패스 비차단화"입니다. 외부 읽기는 `UnifiedDI`/`DIContainer`의 동기 헬퍼(스냅샷 기반)로 통일되며, 내부 트래킹은 액터 격리하에 비차단(Task)으로 전송됩니다.

### 주요 변경점

- (Breaking) AutoDIOptimizer의 다수 읽기용(nonisolated/static) API를 내부화(internal) 또는 Deprecated 처리
  - 외부에서는 `UnifiedDI`/`DIContainer`의 동기 헬퍼만 사용
  - 내부에서만 `readSnapshot()`을 사용해 스냅샷을 읽고 필요한 정보를 계산
- AutoMonitor를 `@DIActor`로 정렬하여 내부 hop 제거
- 추적 호출(register/resolve)은 fire-and-forget(Task)로 비차단 전송
- 스냅샷/그래프 갱신 100ms 디바운스(기본값)

## 영향도

대부분의 프로젝트는 다음 항목만 확인하면 됩니다.

1) AutoDIOptimizer의 읽기 API를 직접 호출하던 코드가 있다면 다음 표대로 교체
2) 테스트에서 타이밍 민감한 검증은 스냅샷 반영 대기를 폴링(waitUntil/waitAsyncUntil)으로 변경

## API 매핑(Deprecated → Replacement)

| Deprecated (AutoDIOptimizer) | Replacement |
|---|---|
| `getCurrentStats()` | `UnifiedDI.stats()` / `DIContainer.getUsageStatistics()` |
| `visualizeGraph()` | `UnifiedDI.autoGraph()` / `DIContainer.getAutoGeneratedGraph()` |
| `getFrequentlyUsedTypes()` | `UnifiedDI.optimizedTypes()` / `DIContainer.getOptimizedTypes()` |
| `getDetectedCircularDependencies()` | `UnifiedDI.circularDependencies()` / `DIContainer.getDetectedCircularDependencies()` |
| `isOptimized(_:)` | `UnifiedDI.isOptimized(_:)` / `DIContainer.isAutoOptimized(_:)` |
| `getActorOptimizationSuggestions()` | `UnifiedDI.actorOptimizations` |
| `getDetectedTypeSafetyIssues()` | `UnifiedDI.typeSafetyIssues` |
| `getDetectedAutoFixedTypes()` | `UnifiedDI.autoFixedTypes` |
| `getActorHopStats()` | `UnifiedDI.actorHopStats` |
| `getAsyncPerformanceStats()` | `UnifiedDI.asyncPerformanceStats` |
| `getRecentGraphChanges(...)` | `UnifiedDI.getGraphChanges(...)` |
| `getCurrentLogLevel()` | `UnifiedDI.logLevel` / `UnifiedDI.getLogLevel()` |

> 내부 용도: `AutoDIOptimizer.readSnapshot()`으로 스냅샷을 읽어 필요한 값을 계산하세요.

## 코드 변경 예시

### 그래프/통계 읽기

```diff
- let graph = AutoDIOptimizer.shared.visualizeGraph()
+ let graph = UnifiedDI.autoGraph()

- let stats = AutoDIOptimizer.shared.getCurrentStats()
+ let stats = UnifiedDI.stats()

- let optimized = AutoDIOptimizer.shared.getFrequentlyUsedTypes()
+ let optimized = UnifiedDI.optimizedTypes()
```

### 로그 레벨

```diff
- let level = AutoDIOptimizer.shared.getCurrentLogLevel()
+ let level = UnifiedDI.logLevel

- AutoDIOptimizer.shared.setLogLevel(.errors)
+ UnifiedDI.setLogLevel(.errors)
```

### 순환 의존성

```diff
- let cycles = AutoDIOptimizer.shared.getDetectedCircularDependencies()
+ let cycles = UnifiedDI.circularDependencies()
```

## 테스트 마이그레이션 팁

- 스냅샷은 비차단 전송 후 디바운스(기본 100ms)로 반영됩니다. 타이밍 민감한 테스트는 폴링 헬퍼를 사용하세요.

```swift
waitUntil(description: "wait snapshot") {
    UnifiedDI.autoGraph().contains("SomeType")
}
```

## 성능 관련

- 디바운스 간격은 `UnifiedDI.configureOptimization(debounceMs:)`에서 설정 가능합니다(권장: 50/100/200ms 실험).
- 핫패스에서 추적은 fire-and-forget(Task)로 비차단 전송되어 p95/p99 지연 개선에 유리합니다.

## 부트스트랩 관련(변경 없음)

- 2.x.x의 부트스트랩 API 그대로 사용 가능합니다. 상세는 <doc:Bootstrap>.

## FAQ

### AutoDIOptimizer.readSnapshot()을 외부에서 써도 되나요?
내부용을 권장합니다. 외부에서는 `UnifiedDI`/`DIContainer`의 동기 헬퍼(스냅샷 기반)를 사용하세요.

### Deprecated API는 언제 제거되나요?
3.x에서 Deprecated로 유지되며, 4.0에서 제거될 수 있습니다. 본 문서의 Replacement로 교체하세요.
