# WeaveDI 3.0.0 Migration Guide

This document outlines the necessary changes and recommended migration paths when upgrading from 2.x.x to 3.0.0.

## Summary

The core of 3.0.0 is "unified read paths" and "hot-path non-blocking". External reads are unified with synchronous helpers from `UnifiedDI`/`DIContainer` (snapshot-based), and internal tracking is sent non-blocking (Task) under actor isolation.

### Major Changes

- (Breaking) Internalized (internal) or deprecated multiple read APIs from AutoDIOptimizer (nonisolated/static)
  - Externally, only use synchronous helpers from `UnifiedDI`/`DIContainer`
  - Internally, only use `readSnapshot()` to read snapshots and calculate necessary information
- Aligned AutoMonitor with `@DIActor` to eliminate internal hops
- Tracking calls (register/resolve) are sent non-blocking via fire-and-forget (Task)
- Snapshot/graph updates with 100ms debounce (default)

## Impact

Most projects only need to check the following items:

1) If there's code directly calling AutoDIOptimizer's read APIs, replace according to the table below
2) For timing-sensitive validation in tests, change snapshot reflection waiting to polling (waitUntil/waitAsyncUntil)

## API Mapping (Deprecated â†’ Replacement)

| Deprecated (AutoDIOptimizer) | Replacement |
|---|---|
| `getCurrentStats()` | `UnifiedDI.stats()` / `DIContainer.getUsageStatistics()` |
| `visualizeGraph()` | `UnifiedDI.autoGraph()` / `DIContainer.getAutoGeneratedGraph()` |
| `getFrequentlyUsedTypes()` | `UnifiedDI.optimizedTypes()` / `DIContainer.getOptimizedTypes()` |
| `getDetectedCircularDependencies()` | `UnifiedDI.circularDependencies()` / `DIContainer.getDetectedCircularDependencies()` |
| `isOptimized(_:)` | `UnifiedDI.isOptimized(_:)` / `DIContainer.isAutoOptimized(_:)` |
| `getActorOptimizationSuggestions()` | `UnifiedDI.actorOptimizations` |
| `getDetectedTypeSafetyIssues()` | `UnifiedDI.typeSafetyIssues` |
| `getDetectedAutoFixedTypes()` | `UnifiedDI.autoFixedTypes` |
| `getActorHopStats()` | `UnifiedDI.actorHopStats` |
| `getAsyncPerformanceStats()` | `UnifiedDI.asyncPerformanceStats` |
| `getRecentGraphChanges(...)` | `UnifiedDI.getGraphChanges(...)` |
| `getCurrentLogLevel()` | `UnifiedDI.logLevel` / `UnifiedDI.getLogLevel()` |

> Internal use: Read snapshots with `AutoDIOptimizer.readSnapshot()` and calculate necessary values.

## Code Change Examples

### Graph/Statistics Reading

```diff
- let graph = AutoDIOptimizer.shared.visualizeGraph()
+ let graph = UnifiedDI.autoGraph()

- let stats = AutoDIOptimizer.shared.getCurrentStats()
+ let stats = UnifiedDI.stats()

- let optimized = AutoDIOptimizer.shared.getFrequentlyUsedTypes()
+ let optimized = UnifiedDI.optimizedTypes()
```

### Log Level

```diff
- AutoDIOptimizer.shared.setLogLevel(.errors)
+ UnifiedDI.setLogLevel(.errors)

- let level = AutoDIOptimizer.shared.getCurrentLogLevel()
+ let level = UnifiedDI.logLevel
```

### Test Timing

```diff
// Before: Immediate check (might fail due to async updates)
- let stats = AutoDIOptimizer.shared.getCurrentStats()
- XCTAssertEqual(stats["UserService"], 1)

// After: Wait for snapshot reflection
+ await waitAsyncUntil { UnifiedDI.stats()["UserService"] == 1 }
```

## New Features in 3.0.0

### Runtime Hot-Path Optimization
- TypeID + index access for O(1) resolution
- Lock-free snapshot reads for better concurrency
- Factory chain elimination for direct call paths

```swift
// Enable optimization mode
UnifiedRegistry.shared.enableOptimization()

// Existing code automatically gets performance improvements
let service = await UnifiedDI.resolve(UserService.self)
```

### Enhanced Performance Tracking
- Real-time statistics with snapshot consistency
- Actor hop optimization suggestions
- Automatic type safety validation

## Migration Checklist

- [ ] Replace all direct AutoDIOptimizer read API calls
- [ ] Update test timing expectations for async updates
- [ ] Consider enabling runtime optimization for production
- [ ] Review logging configuration if using custom log levels
- [ ] Test snapshot consistency in critical paths