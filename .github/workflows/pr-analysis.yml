name: PR Analysis & Auto Comment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  analyze-pr:
    name: Analyze PR Changes
    runs-on: macos-latest

    steps:
    - name: ğŸ“¥ Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}

    - name: ğŸ“¥ Checkout Base Branch
      run: |
        git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}

    - name: ğŸ”§ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'

    - name: ğŸ“Š Analyze Changes
      id: analyze
      run: |
        # ë³€ê²½ëœ íŒŒì¼ë“¤ ë¶„ì„
        git diff --name-only ${{ github.base_ref }}..HEAD > changed_files.txt

        # Swift íŒŒì¼ ê°œìˆ˜
        SWIFT_FILES=$(grep -c "\.swift$" changed_files.txt || echo "0")

        # í…ŒìŠ¤íŠ¸ íŒŒì¼ ê°œìˆ˜
        TEST_FILES=$(grep -c "Tests.*\.swift$" changed_files.txt || echo "0")

        # ë¬¸ì„œ íŒŒì¼ ê°œìˆ˜
        DOC_FILES=$(grep -c -E "\.(md|txt)$" changed_files.txt || echo "0")

        # ì„¤ì • íŒŒì¼ ê°œìˆ˜
        CONFIG_FILES=$(grep -c -E "\.(yml|yaml|json|plist)$" changed_files.txt || echo "0")

        # ë¼ì¸ ìˆ˜ ë³€ê²½ëŸ‰ ê³„ì‚°
        ADDITIONS=$(git diff --numstat ${{ github.base_ref }}..HEAD | awk '{sum+=$1} END {print sum+0}')
        DELETIONS=$(git diff --numstat ${{ github.base_ref }}..HEAD | awk '{sum+=$2} END {print sum+0}')

        echo "swift_files=$SWIFT_FILES" >> $GITHUB_OUTPUT
        echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT
        echo "doc_files=$DOC_FILES" >> $GITHUB_OUTPUT
        echo "config_files=$CONFIG_FILES" >> $GITHUB_OUTPUT
        echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
        echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT

    - name: ğŸ—ï¸ Build and Test
      id: build_test
      run: |
        # ë¹Œë“œ ì„±ê³µ ì—¬ë¶€ í™•ì¸
        if swift build --configuration release 2>&1 | tee build.log; then
          echo "build_status=âœ… Success" >> $GITHUB_OUTPUT
        else
          echo "build_status=âŒ Failed" >> $GITHUB_OUTPUT
        fi

        # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        if swift test 2>&1 | tee test.log; then
          echo "test_status=âœ… Passed" >> $GITHUB_OUTPUT
        else
          echo "test_status=âŒ Failed" >> $GITHUB_OUTPUT
        fi

        # í…ŒìŠ¤íŠ¸ ê°œìˆ˜ í™•ì¸
        TEST_COUNT=$(grep -c "Test Case.*passed" test.log || echo "0")
        echo "test_count=$TEST_COUNT" >> $GITHUB_OUTPUT

    - name: ğŸ” Code Quality Check
      id: quality
      run: |
        # SwiftLint ì‹¤í–‰ (ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ë©´)
        if command -v swiftlint &> /dev/null; then
          swiftlint lint --reporter json > swiftlint_results.json 2>/dev/null || true
          LINT_ISSUES=$(jq length swiftlint_results.json 2>/dev/null || echo "0")
          echo "lint_issues=$LINT_ISSUES" >> $GITHUB_OUTPUT
        else
          echo "lint_issues=N/A" >> $GITHUB_OUTPUT
        fi

        # TODO/FIXME ê°œìˆ˜ í™•ì¸
        TODO_COUNT=$(git diff ${{ github.base_ref }}..HEAD | grep -c "TODO\|FIXME" || echo "0")
        echo "todo_count=$TODO_COUNT" >> $GITHUB_OUTPUT

    - name: ğŸ“ˆ Performance Impact Analysis
      id: performance
      run: |
        # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ìˆë‹¤ë©´)
        if swift test --filter PerformanceTests 2>&1 | tee perf.log; then
          echo "perf_status=âœ… Completed" >> $GITHUB_OUTPUT
        else
          echo "perf_status=âš ï¸ No performance tests or failed" >> $GITHUB_OUTPUT
        fi

        # ë©”ëª¨ë¦¬ ì˜í–¥ë„ ë¶„ì„ (ê°„ë‹¨í•œ ì¶”ì •)
        if grep -q "class.*Service\|struct.*Service" changed_files.txt; then
          echo "memory_impact=ğŸ§  Medium - DI services modified" >> $GITHUB_OUTPUT
        elif grep -q "Protocol\|protocol" changed_files.txt; then
          echo "memory_impact=ğŸ”§ Low - Protocol changes" >> $GITHUB_OUTPUT
        else
          echo "memory_impact=âœ¨ Minimal" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ¤– Generate AI-Style Analysis
      id: ai_analysis
      run: |
        # PR ë¶„ì„ ê²°ê³¼ë¥¼ AI ìŠ¤íƒ€ì¼ë¡œ ìš”ì•½
        cat > ai_analysis.md << EOF
        ## ğŸ¤– WeaveDI Auto-Analyzer Report

        ### ğŸ“Š Change Summary
        - **Swift Files Modified**: ${{ steps.analyze.outputs.swift_files }}
        - **Test Files**: ${{ steps.analyze.outputs.test_files }}
        - **Lines Added**: +${{ steps.analyze.outputs.additions }}
        - **Lines Removed**: -${{ steps.analyze.outputs.deletions }}

        ### ğŸ” Impact Analysis
        EOF

        # DI ê´€ë ¨ ë³€ê²½ì‚¬í•­ ë¶„ì„
        if git diff ${{ github.base_ref }}..HEAD | grep -q "UnifiedDI\|@Injected\|DIContainer"; then
          echo "- ğŸ¯ **DI Core Changes Detected**: This PR modifies core dependency injection functionality" >> ai_analysis.md
        fi

        if git diff ${{ github.base_ref }}..HEAD | grep -q "Performance\|Benchmark"; then
          echo "- âš¡ **Performance Related**: Changes may impact performance characteristics" >> ai_analysis.md
        fi

        if git diff ${{ github.base_ref }}..HEAD | grep -q "Test\|Mock"; then
          echo "- ğŸ§ª **Test Coverage**: Test-related modifications detected" >> ai_analysis.md
        fi

        cat >> ai_analysis.md << EOF

        ### ğŸ—ï¸ Build & Test Status
        - **Build**: ${{ steps.build_test.outputs.build_status }}
        - **Tests**: ${{ steps.build_test.outputs.test_status }} (${{ steps.build_test.outputs.test_count }} tests)
        - **Code Quality**: ${{ steps.quality.outputs.lint_issues }} lint issues
        - **TODOs Added**: ${{ steps.quality.outputs.todo_count }}

        ### ğŸ“ˆ Performance Impact
        - **Performance Tests**: ${{ steps.performance.outputs.perf_status }}
        - **Memory Impact**: ${{ steps.performance.outputs.memory_impact }}
        EOF

        # ê¶Œì¥ì‚¬í•­ ìƒì„±
        cat >> ai_analysis.md << EOF

        ### ğŸ’¡ Auto-Analyzer Recommendations
        EOF

        if [ "${{ steps.analyze.outputs.test_files }}" = "0" ] && [ "${{ steps.analyze.outputs.swift_files }}" != "0" ]; then
          echo "- ğŸ§ª Consider adding unit tests for new Swift code" >> ai_analysis.md
        fi

        if [ "${{ steps.quality.outputs.todo_count }}" != "0" ]; then
          echo "- ğŸ“ ${{ steps.quality.outputs.todo_count }} TODO/FIXME items added - consider addressing before merge" >> ai_analysis.md
        fi

        if git diff ${{ github.base_ref }}..HEAD | grep -q "public\|open"; then
          echo "- ğŸ“š Public API changes detected - ensure documentation is updated" >> ai_analysis.md
        fi

        cat >> ai_analysis.md << EOF

        ### ğŸ¯ Focus Areas for Review
        EOF

        # ë¦¬ë·° í¬ì¸íŠ¸ ìƒì„±
        if git diff ${{ github.base_ref }}..HEAD | grep -q "UnifiedDI.*register"; then
          echo "- ğŸ” **DI Registration**: Verify dependency registration correctness" >> ai_analysis.md
        fi

        if git diff ${{ github.base_ref }}..HEAD | grep -q "@Injected"; then
          echo "- ğŸ” **Property Injection**: Check @Injected usage patterns" >> ai_analysis.md
        fi

        if git diff ${{ github.base_ref }}..HEAD | grep -q "async\|await"; then
          echo "- ğŸ” **Async/Await**: Review async dependency injection patterns" >> ai_analysis.md
        fi

    - name: ğŸ¨ Generate Visual Diff Summary
      id: visual_diff
      run: |
        # ì‹œê°ì  diff ìš”ì•½ ìƒì„±
        cat > visual_diff.md << EOF

        ## ğŸ“Š Visual Change Summary

        \`\`\`
        Files Changed: ${{ steps.analyze.outputs.swift_files }} Swift | ${{ steps.analyze.outputs.test_files }} Tests | ${{ steps.analyze.outputs.doc_files }} Docs
        Line Changes: +${{ steps.analyze.outputs.additions }} -${{ steps.analyze.outputs.deletions }}

        ğŸ“ Modified Files:
        EOF

        while IFS= read -r file; do
          echo "   ğŸ“„ $file" >> visual_diff.md
        done < changed_files.txt

        echo "\`\`\`" >> visual_diff.md

    - name: ğŸ’¬ Post Analysis Comment
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          // ë¶„ì„ ê²°ê³¼ ì½ê¸°
          const aiAnalysis = fs.readFileSync('ai_analysis.md', 'utf8');
          const visualDiff = fs.readFileSync('visual_diff.md', 'utf8');

          // PR ë²ˆí˜¸ í™•ì¸
          const prNumber = context.issue.number;

          // ê¸°ì¡´ ë´‡ ëŒ“ê¸€ ì°¾ê¸°
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber
          });

          const botComment = comments.data.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('ğŸ¤– WeaveDI Auto-Analyzer Report')
          );

          const commentBody = `${aiAnalysis}
          ${visualDiff}

          ---

          ğŸ”„ *This analysis is automatically updated on each push*

          â° *Last updated: ${new Date().toISOString()}*

          ğŸ¤– *Powered by WeaveDI Auto-Analyzer*`;

          if (botComment) {
            // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            // ìƒˆ ëŒ“ê¸€ ìƒì„±
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
          }

    - name: ğŸ·ï¸ Auto Label PR
      uses: actions/github-script@v7
      with:
        script: |
          const labels = [];

          // ë³€ê²½ ê·œëª¨ì— ë”°ë¥¸ ë¼ë²¨
          const additions = parseInt('${{ steps.analyze.outputs.additions }}');
          const deletions = parseInt('${{ steps.analyze.outputs.deletions }}');
          const totalChanges = additions + deletions;

          if (totalChanges < 10) {
            labels.push('size/XS');
          } else if (totalChanges < 50) {
            labels.push('size/S');
          } else if (totalChanges < 200) {
            labels.push('size/M');
          } else if (totalChanges < 500) {
            labels.push('size/L');
          } else {
            labels.push('size/XL');
          }

          // ë³€ê²½ ìœ í˜•ì— ë”°ë¥¸ ë¼ë²¨
          const changedFiles = require('fs').readFileSync('changed_files.txt', 'utf8');

          if (changedFiles.includes('Test')) {
            labels.push('type/test');
          }

          if (changedFiles.includes('.md')) {
            labels.push('type/documentation');
          }

          if (changedFiles.includes('Sources/')) {
            labels.push('type/enhancement');
          }

          // ë¹Œë“œ ìƒíƒœì— ë”°ë¥¸ ë¼ë²¨
          if ('${{ steps.build_test.outputs.build_status }}'.includes('Failed')) {
            labels.push('status/build-failed');
          }

          if ('${{ steps.build_test.outputs.test_status }}'.includes('Failed')) {
            labels.push('status/tests-failed');
          }

          // ë¼ë²¨ ì ìš©
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labels
            });
          }

    - name: ğŸ¯ Create Performance Comparison
      if: steps.performance.outputs.perf_status == 'âœ… Completed'
      run: |
        echo "## ğŸ“Š Performance Comparison" > perf_comparison.md
        echo "" >> perf_comparison.md
        echo "Performance tests completed successfully!" >> perf_comparison.md
        echo "Detailed performance metrics have been collected and will be available in the CI logs." >> perf_comparison.md