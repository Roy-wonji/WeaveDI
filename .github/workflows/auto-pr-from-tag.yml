name: Auto PR from Tag

on:
  push:
    tags:
      - 'v*'          # v1.0.0, v2.1.3 ë“± ë²„ì „ íƒœê·¸
      - '[0-9]*'      # 3.0.0, 3.1.5 ë“± ë²„ì „ íƒœê·¸ (v ì ‘ë‘ì‚¬ ì—†ìŒ)
      - 'release-*'   # release-3.4.0 ë“± ë¦´ë¦¬ì¦ˆ ì¤€ë¹„ íƒœê·¸
      - 'pr-*'        # pr-feature-name ë“± PR ìƒì„± íƒœê·¸

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr-from-tag:
    name: Create PR from Tag
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ·ï¸ Extract Tag Information
      id: tag_info
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

        # íƒœê·¸ íƒ€ìž… ê²°ì •
        if [[ $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
          echo "tag_type=version" >> $GITHUB_OUTPUT
          echo "pr_type=release" >> $GITHUB_OUTPUT
        elif [[ $TAG_NAME =~ ^[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
          echo "tag_type=version" >> $GITHUB_OUTPUT
          echo "pr_type=release" >> $GITHUB_OUTPUT
        elif [[ $TAG_NAME =~ ^release-.*$ ]]; then
          echo "tag_type=release" >> $GITHUB_OUTPUT
          echo "pr_type=release" >> $GITHUB_OUTPUT
        elif [[ $TAG_NAME =~ ^pr-.*$ ]]; then
          echo "tag_type=feature" >> $GITHUB_OUTPUT
          echo "pr_type=feature" >> $GITHUB_OUTPUT
        else
          echo "tag_type=general" >> $GITHUB_OUTPUT
          echo "pr_type=general" >> $GITHUB_OUTPUT
        fi

        # ë¸Œëžœì¹˜ ì´ë¦„ ìƒì„±
        BRANCH_NAME="auto-pr/${TAG_NAME}"
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

        echo "ðŸ·ï¸ Tag: $TAG_NAME"
        echo "ðŸŒ¿ Branch: $BRANCH_NAME"

    - name: ðŸ” Check if Branch Already Exists
      id: branch_check
      run: |
        if git ls-remote --heads origin ${{ steps.tag_info.outputs.branch_name }} | grep -q ${{ steps.tag_info.outputs.branch_name }}; then
          echo "branch_exists=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Branch already exists"
        else
          echo "branch_exists=false" >> $GITHUB_OUTPUT
          echo "âœ… Branch does not exist"
        fi

    - name: ðŸŒ¿ Create New Branch from Tag
      if: steps.branch_check.outputs.branch_exists == 'false'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        # íƒœê·¸ì—ì„œ ìƒˆ ë¸Œëžœì¹˜ ìƒì„±
        git checkout -b ${{ steps.tag_info.outputs.branch_name }}

        echo "âœ… Created branch: ${{ steps.tag_info.outputs.branch_name }}"

    - name: ðŸ“Š Generate Changelog
      id: changelog
      run: |
        # ì´ì „ íƒœê·¸ ì°¾ê¸°
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

        if [ -n "$PREVIOUS_TAG" ]; then
          echo "ðŸ“ˆ Generating changelog from $PREVIOUS_TAG to ${{ steps.tag_info.outputs.tag_name }}"

          # ì»¤ë°‹ ë©”ì‹œì§€ë“¤ì„ ìˆ˜ì§‘
          git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..${{ steps.tag_info.outputs.tag_name }} > changelog_raw.txt

          # ì²´ì¸ì§€ë¡œê·¸ ìƒì„±
          cat > CHANGELOG_EXCERPT.md << EOF
        ## ðŸš€ Changes in ${{ steps.tag_info.outputs.tag_name }}

        ### ðŸ“‹ Commits since $PREVIOUS_TAG:
        EOF
          cat changelog_raw.txt >> CHANGELOG_EXCERPT.md
        else
          echo "ðŸ“‹ No previous tag found, creating initial changelog"
          cat > CHANGELOG_EXCERPT.md << EOF
        ## ðŸš€ Initial Release ${{ steps.tag_info.outputs.tag_name }}

        ### ðŸŽ¯ Features:
        - Initial release of WeaveDI
        - Core dependency injection functionality
        - Auto DI Optimizer
        - TCA integration support
        EOF
        fi

        echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

    - name: ðŸ“ Create Release Notes
      id: release_notes
      if: steps.tag_info.outputs.pr_type == 'release'
      run: |
        cat > RELEASE_NOTES.md << EOF
        # ðŸŽ‰ WeaveDI ${{ steps.tag_info.outputs.tag_name }} Release

        ## ðŸ“Š Release Information
        - **Version**: ${{ steps.tag_info.outputs.tag_name }}
        - **Release Date**: $(date +"%Y-%m-%d")
        - **Previous Version**: ${{ steps.changelog.outputs.previous_tag }}

        ## ðŸš€ What's New

        $(cat CHANGELOG_EXCERPT.md)

        ## ðŸ”§ Installation

        ### Swift Package Manager
        \`\`\`swift
        dependencies: [
            .package(url: "https://github.com/Roy-wonji/WeaveDI", from: "${{ steps.tag_info.outputs.tag_name }}")
        ]
        \`\`\`

        ## ðŸ“š Documentation
        - [Quick Start Guide](https://roy-wonji.github.io/WeaveDI/guide/quick-start.html)
        - [API Reference](https://roy-wonji.github.io/WeaveDI/api/core-apis.html)
        - [Migration Guide](https://roy-wonji.github.io/WeaveDI/guide/migration.html)

        ## ðŸ¤ Contributing
        We welcome contributions! Please see our [Contributing Guide](CONTRIBUTING.md) for details.

        ## ðŸ“„ License
        This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
        EOF

    - name: ðŸ”„ Update Version Files (for version tags)
      if: steps.tag_info.outputs.tag_type == 'version'
      run: |
        # Package.swiftì—ì„œ ë²„ì „ ì—…ë°ì´íŠ¸ (ìžˆë‹¤ë©´)
        if grep -q "version:" Package.swift; then
          sed -i.bak "s/version: \".*\"/version: \"${{ steps.tag_info.outputs.tag_name }}\"/" Package.swift
          rm Package.swift.bak
          echo "âœ… Updated Package.swift version"
        fi

        # README.mdì—ì„œ ë²„ì „ ì—…ë°ì´íŠ¸ (ìžˆë‹¤ë©´)
        if grep -q "from.*WeaveDI" README.md; then
          sed -i.bak "s/from: \".*\"/from: \"${{ steps.tag_info.outputs.tag_name }}\"/" README.md
          rm README.md.bak
          echo "âœ… Updated README.md version"
        fi

        # ë³€ê²½ì‚¬í•­ì´ ìžˆìœ¼ë©´ ì»¤ë°‹
        if ! git diff --quiet; then
          git add .
          git commit -m "ðŸ”– Update version to ${{ steps.tag_info.outputs.tag_name }}"
          echo "âœ… Committed version updates"
        fi

    - name: ðŸ“¤ Push Branch
      if: steps.branch_check.outputs.branch_exists == 'false'
      run: |
        git push origin ${{ steps.tag_info.outputs.branch_name }}
        echo "âœ… Pushed branch: ${{ steps.tag_info.outputs.branch_name }}"

    - name: ðŸŽ¯ Generate PR Title and Body
      id: pr_content
      run: |
        case "${{ steps.tag_info.outputs.pr_type }}" in
          "release")
            PR_TITLE="ðŸš€ Release ${{ steps.tag_info.outputs.tag_name }}"
            cat > PR_BODY.md << EOF
        ## ðŸŽ‰ Release PR for ${{ steps.tag_info.outputs.tag_name }}

        This PR was automatically created from the tag \`${{ steps.tag_info.outputs.tag_name }}\`.

        ### ðŸ“‹ Release Checklist
        - [ ] ðŸ“Š Review changelog
        - [ ] ðŸ§ª Verify all tests pass
        - [ ] ðŸ“š Update documentation
        - [ ] ðŸ·ï¸ Confirm version numbers
        - [ ] ðŸ” Final code review
        - [ ] ðŸš€ Ready for release

        ### ðŸ“ˆ Changes
        $(cat CHANGELOG_EXCERPT.md)

        ### ðŸ“ Release Notes
        $(cat RELEASE_NOTES.md)

        ---
        ðŸ¤– *Auto-generated from tag by WeaveDI Release Bot*
        EOF
            ;;
          "feature")
            FEATURE_NAME=$(echo ${{ steps.tag_info.outputs.tag_name }} | sed 's/^pr-//')
            PR_TITLE="âœ¨ Feature: $FEATURE_NAME"
            cat > PR_BODY.md << EOF
        ## âœ¨ Feature PR: $FEATURE_NAME

        This PR was automatically created from the tag \`${{ steps.tag_info.outputs.tag_name }}\`.

        ### ðŸŽ¯ Feature Description
        Please describe the feature implemented in this PR.

        ### ðŸ§ª Testing
        - [ ] Unit tests added/updated
        - [ ] Integration tests pass
        - [ ] Manual testing completed

        ### ðŸ“š Documentation
        - [ ] Code comments updated
        - [ ] API documentation updated
        - [ ] README updated (if needed)

        ### ðŸ“ˆ Changes
        $(cat CHANGELOG_EXCERPT.md)

        ---
        ðŸ¤– *Auto-generated from tag by WeaveDI Feature Bot*
        EOF
            ;;
          *)
            PR_TITLE="ðŸ”„ Auto PR from tag ${{ steps.tag_info.outputs.tag_name }}"
            cat > PR_BODY.md << EOF
        ## ðŸ”„ Automatic PR from Tag

        This PR was automatically created from the tag \`${{ steps.tag_info.outputs.tag_name }}\`.

        ### ðŸ“ˆ Changes
        $(cat CHANGELOG_EXCERPT.md)

        ---
        ðŸ¤– *Auto-generated from tag by WeaveDI Bot*
        EOF
            ;;
        esac

        echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT

    - name: ðŸ” Check if PR Already Exists
      id: pr_check
      run: |
        # ë™ì¼í•œ ë¸Œëžœì¹˜ë¡œë¶€í„°ì˜ PRì´ ì´ë¯¸ ìžˆëŠ”ì§€ í™•ì¸
        EXISTING_PR=$(gh pr list --head ${{ steps.tag_info.outputs.branch_name }} --json number --jq '.[0].number' 2>/dev/null || echo "")

        if [ -n "$EXISTING_PR" ]; then
          echo "pr_exists=true" >> $GITHUB_OUTPUT
          echo "existing_pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          echo "âš ï¸ PR already exists: #$EXISTING_PR"
        else
          echo "pr_exists=false" >> $GITHUB_OUTPUT
          echo "âœ… No existing PR found"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ†• Create New PR
      if: steps.pr_check.outputs.pr_exists == 'false'
      id: create_pr
      run: |
        PR_URL=$(gh pr create \
          --title "${{ steps.pr_content.outputs.pr_title }}" \
          --body-file PR_BODY.md \
          --base main \
          --head ${{ steps.tag_info.outputs.branch_name }} \
          --label "automated-pr,from-tag" \
          --label "type/${{ steps.tag_info.outputs.pr_type }}")

        PR_NUMBER=$(echo $PR_URL | grep -o '[0-9]\+$')

        echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

        echo "ðŸŽ‰ Created PR: $PR_URL"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ”„ Update Existing PR
      if: steps.pr_check.outputs.pr_exists == 'true'
      run: |
        gh pr edit ${{ steps.pr_check.outputs.existing_pr_number }} \
          --title "${{ steps.pr_content.outputs.pr_title }}" \
          --body-file PR_BODY.md

        echo "ðŸ”„ Updated existing PR: #${{ steps.pr_check.outputs.existing_pr_number }}"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ·ï¸ Add Additional Labels
      if: steps.pr_check.outputs.pr_exists == 'false'
      run: |
        PR_NUMBER=${{ steps.create_pr.outputs.pr_number }}

        # íƒœê·¸ íƒ€ìž…ì— ë”°ë¥¸ ì¶”ê°€ ë¼ë²¨
        case "${{ steps.tag_info.outputs.tag_type }}" in
          "version")
            gh pr edit $PR_NUMBER --add-label "release,version-bump"
            ;;
          "release")
            gh pr edit $PR_NUMBER --add-label "release,needs-review"
            ;;
          "feature")
            gh pr edit $PR_NUMBER --add-label "enhancement,feature"
            ;;
        esac

        # í¬ê¸° ë¼ë²¨ ì¶”ê°€
        CHANGED_FILES=$(git diff --name-only main...)
        FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)

        if [ $FILE_COUNT -lt 5 ]; then
          gh pr edit $PR_NUMBER --add-label "size/S"
        elif [ $FILE_COUNT -lt 15 ]; then
          gh pr edit $PR_NUMBER --add-label "size/M"
        else
          gh pr edit $PR_NUMBER --add-label "size/L"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“¢ Post Summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ðŸŽ‰ Auto PR Created from Tag

        ### ðŸ“‹ Summary
        - **Tag**: \`${{ steps.tag_info.outputs.tag_name }}\`
        - **Branch**: \`${{ steps.tag_info.outputs.branch_name }}\`
        - **PR Type**: ${{ steps.tag_info.outputs.pr_type }}
        - **Status**: ${PR_STATUS}

        ### ðŸ”— Links
        ${PR_LINK}

        ### ðŸ“ˆ Next Steps
        1. Review the automatically generated changelog
        2. Update the PR description if needed
        3. Request reviews from team members
        4. Merge when ready!

        ### ðŸ·ï¸ Supported Tag Formats
        - **Version Tags**: \`3.0.0\`, \`v3.1.5\`, \`1.2.3-beta1\`
        - **Release Tags**: \`release-3.4.0\`
        - **Feature Tags**: \`pr-new-feature\`

        ---
        ðŸ¤– *Auto-generated by WeaveDI Tag-to-PR Bot*
        EOF

        if [ "${{ steps.pr_check.outputs.pr_exists }}" == "false" ]; then
          PR_STATUS="âœ… New PR Created"
          PR_LINK="- **PR**: [${{ steps.pr_content.outputs.pr_title }}](${{ steps.create_pr.outputs.pr_url }})"
        else
          PR_STATUS="ðŸ”„ Existing PR Updated"
          PR_LINK="- **PR**: [#${{ steps.pr_check.outputs.existing_pr_number }}](https://github.com/${{ github.repository }}/pull/${{ steps.pr_check.outputs.existing_pr_number }})"
        fi

    - name: ðŸ§¹ Cleanup
      run: |
        rm -f changelog_raw.txt CHANGELOG_EXCERPT.md RELEASE_NOTES.md PR_BODY.md
        echo "ðŸ§¹ Cleaned up temporary files"